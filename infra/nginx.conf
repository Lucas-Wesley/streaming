# Define o número de processos de trabalho (workers). "auto" permite que o Nginx use o número de núcleos de CPU disponíveis.
worker_processes auto;

# Configurações globais sobre conexões de rede
events {
    # Define o número máximo de conexões simultâneas que cada processo worker pode abrir.
    worker_connections 1024;
}

# Bloco principal para o protocolo RTMP (Real-Time Messaging Protocol)
rtmp {
    server {
        # Define a porta que o servidor RTMP vai "ouvir" (padrão é 1935).
        listen 1935;
        
        # Tamanho dos fragmentos de dados enviados.
        chunk_size 4096;

        # Define uma aplicação de streaming chamada "live".
        application live {
            # Habilita o modo de transmissão ao vivo.
            live on;
            
            # Desativa a gravação automática do vídeo no servidor.
            record off;

            # --- SEGURANÇA E AUTENTICAÇÃO ---
            # O Nginx vai chamar essa URL quando o OBS conectar
            # "backend" é o nome do serviço no docker-compose
            on_publish http://backend:3000/auth;
            
            # --- PROCESSAMENTO HLS (Para assistir no navegador) ---
            # Ativa a conversão automática de RTMP para HLS.
            hls on;
            
            # Pasta onde os pedaços de vídeo (.ts) e a lista (.m3u8) serão salvos.
            hls_path /hls/live;
            
            # Tamanho de cada pedaço de vídeo em segundos.
            hls_fragment 3;
            
            # Tempo total de vídeo mantido na lista de reprodução (buffer).
            hls_playlist_length 60;
            
            # Ajuste fino para sincronização e redução de atraso.
            hls_sync 100ms;
        }
    }
}

# Configurações HTTP para servir os arquivos de vídeo para o Player.
http {
    server {
        # Porta onde o servidor HTTP vai rodar para entregar o vídeo (comumente 80, 8080 ou 8888).
        listen 8080;

        # Rota que lida com as requisições para assistir ao vídeo (ex: http://servidor:8080/hls/chave.m3u8)
        # A barra no final de /hls/ é importante para o "alias" funcionar corretamente.
        location /hls/ {
            # Define os tipos de arquivo que serão servidos para que o navegador entenda que é vídeo.
            types {
                application/vnd.apple.mpegurl m3u8; # Arquivo da playlist HLS
                video/mp2t ts;                      # Fragmentos de vídeo
            }
            
            # Usamos "alias" para mapear /hls/ direto para a pasta onde os arquivos estão.
            # Se usássemos "root", o Nginx procuraria em /hls/hls/.
            alias /hls/live/;
            
            # Instrução para o navegador não fazer cache da playlist, garantindo que ele sempre peça o trecho mais novo.
            add_header Cache-Control no-cache;
            
            # Habilita CORS, permitindo que seu Front-end acesse o vídeo de outro domínio.
            # O "always" garante que o cabeçalho seja enviado mesmo em caso de erro (como 404).
            add_header Access-Control-Allow-Origin * always;
        }
    }
}

# DUVIDAS:
## O nginx pode lidar com qualquer tipo de protocolo? R: Sim, ele é um servidor web e pode lidar com qualquer protocolo que tenha uma implementação no nginx.

## No bloco "rtmp", além da "chave" server o que mais pode ser configurado? R: 

## DOCS

