services:
  # -------------------------------------------------------
  # BACKEND (Node.js)
  # Perfil: Baixo consumo. Só coordena autenticação.
  # -------------------------------------------------------
  backend:
    build:
      context: .
    volumes:
      - ../:/app
    ports:
      - 3000:3000
    working_dir: /app
    command: npm run dev
    depends_on:
      - db
    deploy:
      resources:
        limits:
          cpus: '0.25'    # 1/4 de um núcleo é suficiente
          memory: 256M    # Node.js simples roda bem aqui

  # -------------------------------------------------------
  # BANCO DE DADOS (Postgres)
  # Perfil: Consumo estável, precisa de RAM garantida.
  # -------------------------------------------------------
  db:
    image: postgres:14.3
    ports:
      - 5432:5432
    volumes:
      - ../database/base.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=streaming
    deploy:
      resources:
        limits:
          cpus: '0.25'    # Banco parado gasta quase nada
          memory: 512M    # Margem de segurança para não cair

  # -------------------------------------------------------
  # NGINX + FFMPEG (O "Devorador" de Recursos)
  # Perfil: Alta CPU. Com apenas uma transcodificação, 1 núcleo costuma bastar.
  # -------------------------------------------------------
  nginx-rtmp:
    build:
      context: .
      dockerfile: Dockerfile.nginx-rtmp
    image: streaming-nginx-rtmp:local
    container_name: stream_server
    ports:
      - "1935:1935"
      - "8080:8080"
    volumes:
      - ../infra/nginx.conf:/etc/nginx/nginx.conf
      - ../infra/transcode.sh:/usr/local/bin/transcode.sh
      - ../hls:/hls
    depends_on:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.50'    # Aumentado para 1.50 para suportar 3 qualidades
          memory: 1024M   # 1GB só para vídeo (sobra bastante)